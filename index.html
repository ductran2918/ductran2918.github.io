<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mapping Southeast Asian founders in the US</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <h1>Mapping Southeast Asian founders in the US</h1>
  <div id="map"></div>

  <!-- Modal for click details -->
  <div id="modal" class="hidden">
    <div id="modal-content">
      <button id="close-modal">Ã—</button>
      <h2 id="modal-state"></h2>
      <ul id="founder-list"></ul>
    </div>
  </div>

  <script>
  (async function(){
    const width = 960, height = 600;
    const svg = d3.select("#map")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    // 1) Load GeoJSON + CSV
    const [us, data] = await Promise.all([
      d3.json("https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json"),
      d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQufUsi2JP4GslKrQa6Dkys0VZSvz6NgX2Bt_FiZ4i8bXfFwp-9hYpu0m2OPmye_vX8DFvf02uleg_v/pub?gid=150219922&single=true&output=csv")
    ]);

    // 2) Aggregate counts by state & group founders
    const byState = d3.rollups(
      data,
      rows => ({
        count: rows.length,
        founders: rows.map(r => ({
          name: r.founder,
          company: r.company,
          year: r.founded_year,
          vertical: r.vertical
        }))
      }),
      d => d.state
    );
    const stateData = new Map(byState);

    // 3) Color scale (5 discrete bins)
    const allCounts = [...stateData.values()].map(d=>d.count).concat(0);
    const maxCount = d3.max(allCounts);
    const color = d3.scaleQuantize([0, maxCount], [
      "#d1dff6","#c2d6f6","#b2cbf2","#a0bff0","#92b6f0"
    ]);

    // 4) Draw states
    const path = d3.geoPath().projection(d3.geoAlbersUsa());
    svg.selectAll("path")
      .data(us.features)
      .enter().append("path")
        .attr("d", path)
        .attr("fill", d => {
          const st = stateData.get(d.properties.name);
          return color(st ? st.count : 0);
        })
        .on("mouseover", (e, d) => {
          const c = stateData.get(d.properties.name)?.count || 0;
          d3.select("#map").append("div")
            .attr("class","tooltip")
            .style("left",(e.pageX+10)+"px")
            .style("top",(e.pageY+10)+"px")
            .text(`${d.properties.name}: ${c} founder${c===1?"":"s"}`);
        })
        .on("mouseout", () => d3.selectAll(".tooltip").remove())
        .on("click", (e, d) => {
          const info = stateData.get(d.properties.name);
          const list = d3.select("#founder-list").html("");
          if (info) {
            info.founders.forEach(f => {
              list.append("li").text(
                `${f.name} (${f.company}, ${f.year}, ${f.vertical})`
              );
            });
          } else {
            list.append("li").text("No founders");
          }
          d3.select("#modal-state").text(d.properties.name);
          d3.select("#modal").classed("hidden", false);
        });

    // 5) Close modal
    d3.select("#close-modal").on("click", () => {
      d3.select("#modal").classed("hidden", true);
    });
  })();
  </script>
</body>
</html>
